---
description: Reglas crÃ­ticas para el Sistema de Control de Gas - Arquitectura y flujo operativo
globs: app/**/*.tsx, components/**/*.tsx, lib/**/*.ts, actions/**/*.ts
alwaysApply: true
---

# Sistema de Control de Gas - Reglas CrÃ­ticas

## ğŸ—ï¸ **Arquitectura del Sistema**

### **Roles y Acceso Diferenciado**

- **ğŸ‘¨â€ğŸ’¼ JEFE (Admin)**: Acceso completo desde PC/tablet/mÃ³vil

  - Panel "En Ruta" para monitoreo en tiempo real
  - GestiÃ³n completa de inventario
  - ConfiguraciÃ³n de precios personalizados
  - Registro de llegadas de camiÃ³n
  - Todos los reportes y anÃ¡lisis

- **ğŸ‘¨â€ğŸ’» VENDEDOR**: Solo acceso mÃ³vil con funciones limitadas
  - Registro de ventas Ãºnicamente
  - Registro de gastos operativos
  - VisualizaciÃ³n solo de sus propias transacciones
  - Sin acceso a inventario general
  - Sin acceso a reportes financieros

### **Inventario Separado - CRÃTICO**

```typescript
// âœ… DO: Manejar inventarios completamente separados
const inventoryFull = {
  type: '33lb' | '40lb' | '100lb', // Solo marca Roscogas
  quantity: number,
  unitCost: decimal,
};

const inventoryEmpty = {
  type: '33lb' | '40lb' | '100lb',
  brand: string, // Todas las marcas
  color: string, // Todos los colores
  quantity: number,
};
```

### **Tipos de Transacciones - OBLIGATORIO**

```typescript
// âœ… DO: Implementar estos 4 tipos exactos
type SaleType =
  | 'intercambio' // -1 lleno, +1 vacÃ­o (80% de ventas)
  | 'completa' // -1 lleno Ãºnicamente
  | 'venta_vacios' // -1 vacÃ­o
  | 'compra_vacios'; // +1 vacÃ­o
```

## ğŸ›£ï¸ **Panel "En Ruta" - Funcionalidad Central**

### **Cards de Vendedores - SOLO DÃA ACTUAL**

```typescript
// âœ… DO: Mostrar Ãºnicamente datos del dÃ­a actual
interface VendorCard {
  vendorName: string;
  assignedRoute: string;
  cylindersAssigned: number; // Por tipo
  cylindersSold: number; // Por tipo
  cylindersRemaining: number; // Por tipo
  totalSales: number; // Del dÃ­a
  totalExpenses: number; // Del dÃ­a
  dailyMargin: number; // Ventas - Gastos
  progressPercentage: number; // Visual
  lastUpdate: timestamp;
}
```

### **Estados de Cilindros**

```typescript
// âœ… DO: Usar estado STANDBY para asignaciones
type CylinderStatus =
  | 'available' // En inventario general
  | 'standby' // Asignado a vendedor (no afecta inventario)
  | 'sold' // Vendido (actualiza inventario)
  | 'returned'; // Devuelto al final del dÃ­a
```

## ğŸ’° **GestiÃ³n Financiera - Factor CrÃ­tico**

### **Precio de Compra = Rentabilidad**

```typescript
// âœ… DO: El precio de compra determina la ganancia
interface TruckArrival {
  cylindersReceived: number;
  unitCost: decimal; // CRÃTICO: Define rentabilidad
  totalInvoice: decimal;
  freightCost: decimal; // Se paga por separado
}
```

### **CÃ¡lculo de Margen**

```typescript
// âœ… DO: Calcular margen correctamente
const dailyMargin = totalSales - totalExpenses;
const profitPerCylinder = salePrice - purchasePrice;
```

## ğŸ“± **Interfaz MÃ³vil - Vendedores**

### **Formulario de Ventas - Campos Obligatorios**

```typescript
// âœ… DO: Incluir todos estos campos
interface SaleForm {
  customerName: string; // Obligatorio
  customerPhone?: string; // Opcional
  customerLocation: string; // Obligatorio
  productType: '33lb' | '40lb' | '100lb';
  saleType: SaleType;
  amountCharged: decimal;
  paymentMethod: 'efectivo' | 'transferencia' | 'credito';
  timestamp: Date; // AutomÃ¡tico
}
```

### **Formulario de Gastos**

```typescript
// âœ… DO: Categorizar gastos correctamente
interface ExpenseForm {
  type: 'gasolina' | 'comida' | 'reparaciones' | 'otros';
  amount: decimal;
  description: string;
  timestamp: Date;
}
```

## ğŸ”„ **Flujo Operativo Diario**

### **Inicio del DÃ­a (6:00 AM - 8:00 AM)**

1. Jefe asigna cilindros a vendedores
2. Cilindros quedan en estado STANDBY
3. Se crean cards "En Ruta" automÃ¡ticamente

### **Durante el DÃ­a (8:00 AM - 6:00 PM)**

1. Vendedores registran ventas desde mÃ³vil
2. Cards "En Ruta" se actualizan instantÃ¡neamente
3. Inventario se actualiza solo con ventas confirmadas

### **Final del DÃ­a (6:00 PM - 8:00 PM)**

1. Cilindros no vendidos regresan al inventario
2. Cards "En Ruta" se resetean automÃ¡ticamente
3. Datos se consolidan para reportes

## ğŸš¨ **Reglas de ValidaciÃ³n**

### **âŒ DON'T: Operaciones que NO afectan inventario**

- Salida para ruta (solo cambia a STANDBY)
- AsignaciÃ³n a vendedores (solo crea cards)
- Devoluciones al final del dÃ­a (solo cambia estado)

### **âœ… DO: Operaciones que SÃ afectan inventario**

- Venta con intercambio: -1 lleno, +1 vacÃ­o
- Venta completa: -1 lleno
- Venta de vacÃ­os: -1 vacÃ­o
- Compra de vacÃ­os: +1 vacÃ­o
- Llegada de camiÃ³n: +llenos recibidos, -vacÃ­os entregados

## ğŸ“Š **Sistema de Metas**

### **Unidad de Medida: Kilogramos**

```typescript
// âœ… DO: Convertir automÃ¡ticamente
const conversions = {
  '33lb': 15, // kg
  '40lb': 18, // kg
  '100lb': 45, // kg
};
```

### **PerÃ­odos de Metas**

- Semanales, mensuales, semestrales, anuales
- Generales del negocio e individuales por vendedor
- Seguimiento en tiempo real con barras de progreso

## ğŸ” **Seguridad y Permisos**

### **Control de EdiciÃ³n**

- Vendedores solo pueden editar con autorizaciÃ³n del jefe
- Sistema de solicitudes y aprobaciones
- AuditorÃ­a completa de todas las acciones

### **ComunicaciÃ³n Externa**

- WhatsApp para comprobantes y evidencias
- Sin integraciÃ³n tÃ©cnica compleja
- Flujo directo jefe-vendedores

## ğŸ¯ **Objetivo Principal del Sistema**

**Maximizar la rentabilidad** controlando precisamente:

1. **Precio de compra** del gas (factor principal de costos)
2. **Precio de venta** al cliente (personalizable por cliente)
3. **Gastos operativos** (controlados por vendedor)

El sistema debe transformar datos operativos en **informaciÃ³n accionable** para tomar mejores decisiones comerciales y operativas.
